<html>
<head>
</head>
<body>

  <ul id="myUl"></ul>
  <form onsubmit="createTask(this); return false;">
    <label for="ftaskname">Task Name:</label><br>
    <input type="text" id="taskNameUserInput" name="ftaskname"><br>
    <label for="fassignee">Assignee:</label><br>
    <input type="text" id="assigneeUserInput" name="fassignee"><br>
    <input type="submit" value="Submit">
  </form>

  <form onsubmit="updatePassword(this); return false;">
    <label for="foldpassword">Old Password:</label><br>
    <input type="text" id="oldPasswordUserInput" name="foldpassword"><br>
    <label for="fnewpassword">New Password:</label><br>
    <input type="text" id="newPasswordUserInput" name="fnewpassword"><br>
    <label for="fconfirmnewpassword">Confirm New Password:</label><br>
    <input type="text" id="confirmNewPasswordUserInput" name="fconfirmnewpassword"><br>
    <p id="updatePasswordStatus"> Hi I'm status </p>
    <input type="submit" value="Submit">
  </form>

  <button type="button" onclick="logout()">Logout</button>

<script>
  console.log("about to fetch a flower");
  loadDoc();

  // Show tasks in a list format
  function showTasks(param) {
    console.log(param)
    document.getElementById("myUl").innerHTML = "";
    param.data.forEach(function(item) {
      var li = document.createElement("li");
      var text = document.createTextNode("Task name: " + item.TaskName + ", Assignee: " + item.Assignee + ", Is done: " + "false");
      li.setAttribute('id', item.ID)
      li.setAttribute('onclick','deleteTask(this);');
      li.appendChild(text);
      document.getElementById("myUl").appendChild(li);
    });
  } 


function deleteTask(param) {
  fetch('api/tasks/' + param.id, {
  method: 'DELETE',
  headers: {
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json'
  },
  body: null
  }).then(response => {
    console.log(response);
    loadDoc();
  }).catch(e => {
    console.log(e);
  });
}

// Creates task in database 
function createTask(param) {
  var TaskName = document.getElementById("taskNameUserInput").value;
  var Assignee = document.getElementById("assigneeUserInput").value;
  fetch('api/tasks/', {
  method: 'POST',
  headers: {
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({TaskName: TaskName, Assignee: Assignee})
}).then(response => {
    console.log(response);
    loadDoc();
}).catch(e => {
    console.log(e);
});
}

function updatePassword(param) { 
  var oldPassword = document.getElementById("oldPasswordUserInput").value; 
  var newPassword = document.getElementById("newPasswordUserInput").value; 
  var confirmNewPassword = document.getElementById("confirmNewPasswordUserInput").value; 
  if (newPassword != confirmNewPassword) { 
    document.getElementById("updatePasswordStatus").innerHTML = "Passwords don't match."
    return
  }
  fetch('auth/resetPassword/', {
  method: 'PATCH',
  headers: {
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({oldPassword: oldPassword, newPassword: newPassword})
}).then(response => {
    console.log(response);
    if (response.ok) { 
      document.getElementById("updatePasswordStatus").innerHTML = "Password sucessfully updated."
    }
    else { 
      document.getElementById("updatePasswordStatus").innerHTML = "Old password did not match our records."
    }
    loadDoc();
}).catch(e => {
    console.log(e);
});

}

// Requests tasks from database on change 
function loadDoc() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var parsed_data = JSON.parse(this.responseText);
      showTasks(parsed_data);
    }
  };
  xhttp.open("GET", "api/tasks", true);
  xhttp.send();
}

function logout()  {
  fetch('auth/logout/', {
  method: 'POST',
  headers: {
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json'
  },
}).then(response => {
    console.log(response);
}).catch(e => {
    console.log(e);
});
}

</script>
</body>
</html>